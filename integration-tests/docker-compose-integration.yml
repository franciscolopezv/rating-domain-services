version: '3.8'

services:
  # PostgreSQL for write database (integration tests)
  postgres-write-test:
    image: postgres:15-alpine
    container_name: ratings-postgres-write-test
    environment:
      POSTGRES_DB: ratings_write_test
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_pass
    ports:
      - "5434:5432"
    volumes:
      - ./src/test/resources/init-write-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d ratings_write_test"]
      interval: 5s
      timeout: 3s
      retries: 5

  # PostgreSQL for read database (integration tests)
  postgres-read-test:
    image: postgres:15-alpine
    container_name: ratings-postgres-read-test
    environment:
      POSTGRES_DB: ratings_read_test
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_pass
    ports:
      - "5435:5432"
    volumes:
      - ./src/test/resources/init-read-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d ratings_read_test"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Zookeeper for Kafka (integration tests)
  zookeeper-test:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: ratings-zookeeper-test
    environment:
      ZOOKEEPER_CLIENT_PORT: 2182
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2182:2182"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2182"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Kafka (integration tests)
  kafka-test:
    image: confluentinc/cp-kafka:7.4.0
    container_name: ratings-kafka-test
    depends_on:
      zookeeper-test:
        condition: service_healthy
    ports:
      - "9093:9093"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-test:2182
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-test:29093,PLAINTEXT_HOST://localhost:9093
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9093"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  default:
    name: ratings-integration-test-network